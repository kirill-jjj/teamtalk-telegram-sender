# TeamTalk Telegram Sender (TTTM)

Репозиторий: [https://github.com/kirill-jjj/teamtalk-telegram-sender/](https://github.com/kirill-jjj/teamtalk-telegram-sender/)

[English version of README (README.en.md)](README.en.md) 

**Примечание:** Значительная часть кода этого бота (около 80%) была сгенерирована с помощью искусственного интеллекта. Хотя код был протестирован и находится в рабочем или близком к рабочему состоянию, некоторые его части могут быть не оптимальны или не полностью человекочитаемы. Вы можете встретить комментарии от ИИ, вроде `# изменено здесь` или аналогичные, оставленные в процессе разработки и отладки.

**Благодарности:**

*   Особая благодарность **[BlindMaster24](https://github.com/BlindMaster24)**, текущему активному разработчику и мейнтейнеру замечательной библиотеки [py-talk-ex](https://github.com/BlindMaster24/pytalk), за создание фундамента и первоначальной идеи бота, без которых дальнейшая разработка (в том числе с помощью ИИ) была бы затруднительна.
*   Спасибо **[gumerov-amir](https://github.com/gumerov-amir)**, разработчику TTMediaBot и других проектов, за помощь с исправлением команды `/help` после масштабного рефакторинга с использованием ИИ (в ныне удаленной ветке `ai-refactor`).
*   Благодарю **[a11cf0](https://github.com/a11cf0)** за множество исправлений на самом начальном этапе разработки, когда бот только учился пересылать сообщения администратору.

---

Этот бот служит мостом между сервером TeamTalk 5 и Telegram. Он отслеживает события входа и выхода пользователей на сервере TeamTalk и отправляет уведомления в Telegram. Также он может пересылать личные сообщения, адресованные боту в TeamTalk, администратору в Telegram.

## Основные возможности

*   **Уведомления о входе/выходе:** Отправка сообщений в Telegram, когда пользователь подключается или отключается от сервера TeamTalk.
*   **Пересылка личных сообщений:** Личные сообщения, отправленные боту в TeamTalk, могут быть пересланы указанному администратору в Telegram.
*   **Интерактивные настройки через Telegram:**
    *   `/settings`: Предоставляет доступ к комплексному меню для управления языком интерфейса, параметрами подписки на уведомления (все, только о входе, только о выходе, или никаких), списками блокировки/разрешения пользователей (Mute-листы), а также функцией "Не в сети" (NOON).
*   **Просмотр активных пользователей:**
    *   `/who`: Показывает список пользователей, находящихся онлайн на сервере TeamTalk.
*   **Администрирование пользователей TeamTalk (для администраторов Telegram):**
    *   `/kick`: Инициирует процесс исключения пользователя с сервера TeamTalk (выбор пользователя осуществляется через интерактивные кнопки).
    *   `/ban`: Инициирует процесс блокировки (бана) пользователя на сервере TeamTalk (выбор пользователя осуществляется через интерактивные кнопки).
*   **Функция "Не в сети" (Not on Online / NOON):**
    *   Активируется через команду `/sub` в личных сообщениях боту на сервере TeamTalk, что связывает ваш TeamTalk аккаунт с Telegram.
    *   Если функция NOON включена в настройках Telegram (`/settings`) и связанный пользователь TeamTalk находится онлайн, уведомления от бота в Telegram будут приходить без звука.
*   **Команды управления через TeamTalk (в личные сообщения боту):**
    *   `/sub`: Отправляет пользователю deeplink-ссылку для подписки на уведомления в Telegram и для связывания аккаунта TeamTalk для использования функции NOON.
    *   `/unsub`: Отправляет пользователю deeplink-ссылку для отписки от уведомлений в Telegram.
    *   `/add_admin <ID Telegram>`: Позволяет главному администратору (указанному в конфигурации) добавлять других администраторов бота в Telegram.
    *   `/remove_admin <ID Telegram>`: Позволяет главному администратору удалять администраторов бота в Telegram.
    *   `/help`: Отображает справку по доступным командам в TeamTalk.
*   **Многоязычность:** Поддержка русского и английского языков интерфейса в Telegram.
*   **Получение справки:**
    *   `/help`: Отображает справочное сообщение со списком доступных команд и их описанием в Telegram.

## Технологический стек

*   Python 3.11+
*   [aiogram](https://github.com/aiogram/aiogram) (асинхронный фреймворк для Telegram Bot API)
*   [py-talk-ex](https://github.com/BlindMaster24/pytalk) (библиотека для взаимодействия с TeamTalk 5 SDK)
*   SQLAlchemy (ORM для работы с базой данных)
*   Aiosqlite (асинхронный драйвер SQLite)
*   python-dotenv (управление переменными окружения)

## Установка и запуск

1.  **Установите `uv` (если еще не установлен):**
    *   **Для Linux и macOS:**
        ```bash
        curl -LsSf https://astral.sh/uv/install.sh | sh
        source $HOME/.local/bin/env
        ```
    *   **Для Windows:** Самый простой способ, если у вас установлен Python и pip – это выполнить `pip install uv`. Другие способы установки (например, через установщик) можно найти на [официальном сайте Astral](https://astral.sh/uv#installation).

2.  **Клонируйте репозиторий:**
    ```bash
    git clone https://github.com/kirill-jjj/teamtalk-telegram-sender.git
    cd teamtalk-telegram-sender
    ```

3.  **Установите зависимости (команда `uv sync` автоматически создаст виртуальное окружение в папке `.venv`, если оно не существует, и установит в него все необходимые пакеты):**
    ```bash
    uv sync
    ```
    *(Эта команда подготовит окружение со всеми зависимостями.)*

4.  **Настройте переменные окружения:**
    Скопируйте файл `.env.example` в новый файл с именем `.env`:
    ```bash
    cp .env.example .env
    ```
    Затем откройте файл `.env` в текстовом редакторе и заполните его вашими актуальными данными (токенами, адресами серверов, учетными данными и т.д.), следуя комментариям в файле. **Никогда не добавляйте ваш `.env` файл в систему контроля версий (Git).**

5.  **Запустите бота (используя `uv run` для автоматического использования правильного окружения и его синхронизации):**
    ```bash
    uv run python sender.py
    ```
    Если вы хотите указать путь к `.env` файлу, отличающийся от текущей директории:
    ```bash
    uv run python sender.py /путь/к/вашему/.env
    ```

## Использование

### Команды в Telegram

После запуска бота и его первоначальной настройки (рекомендуется инициировать подписку через команду `/sub` в личных сообщениях боту в TeamTalk), вы можете использовать следующие команды в чате с ботом в Telegram:

*   `/start`: Начало работы с ботом. Также используется для обработки deeplink-ссылок (например, для подтверждения подписки или отписки).
*   `/who`: Показать список пользователей, находящихся онлайн на сервере TeamTalk.
*   `/settings`: Открыть интерактивное меню для настройки языка, параметров подписки на уведомления, управления списками блокировки/разрешения пользователей и функции "Не в сети" (NOON).
*   `/help`: Показать справочное сообщение со списком доступных команд и их описанием.

**Команды для администраторов Telegram:**

*   `/kick`: Инициировать исключение пользователя с сервера TeamTalk (выбор пользователя через кнопки).
*   `/ban`: Инициировать блокировку пользователя на сервере TeamTalk (выбор пользователя через кнопки).

### Команды в TeamTalk (в личные сообщения боту)

*   `/sub`: Получить ссылку для подписки на уведомления в Telegram. Этот процесс также связывает вашу учетную запись TeamTalk для функции "Не в сети" (NOON).
*   `/unsub`: Получить ссылку для отписки от уведомлений. Это удалит вашу подписку и все связанные с ней данные и настройки.
*   `/add_admin <ID Telegram_1> <ID Telegram_2> ...`: (Только для главного администратора, указанного в конфигурации) Добавить администраторов бота в Telegram.
*   `/remove_admin <ID Telegram_1> <ID Telegram_2> ...`: (Только для главного администратора, указанного в конфигурации) Удалить администраторов бота в Telegram.
*   `/help`: Показать справку по доступным командам TeamTalk.

Любое другое текстовое сообщение, отправленное боту в TeamTalk в ЛС, будет переслано администратору в Telegram (если `TG_ADMIN_CHAT_ID` указан в конфигурации).

## Замечания по настройке "Не в сети" (NOON)

Функция "Не в сети" (NOON) позволяет доставлять уведомления от бота в Telegram без звука, если связанный с вашим Telegram-аккаунтом пользователь TeamTalk в данный момент находится онлайн. Это помогает уменьшить количество звуковых оповещений, если вы активно используете TeamTalk.

**Активация и управление функцией NOON:**
1.  **Связывание аккаунта:** Отправьте команду `/sub` боту в личные сообщения на сервере TeamTalk. Бот пришлет вам deeplink-ссылку.
2.  **Подтверждение в Telegram:** Откройте эту ссылку в Telegram и нажмите "Старт". Это действие подпишет вас на уведомления и свяжет ваш аккаунт TeamTalk для функции NOON.
3.  **Управление NOON:** После связывания, управление функцией NOON (включение/выключение) осуществляется через меню `/settings` в Telegram.

Если функция NOON включена и связанная учетная запись TeamTalk находится онлайн на сервере, уведомления от бота в Telegram будут приходить без звука.

## Вклад (Contributing)

Предложения по улучшению и сообщения об ошибках приветствуются! Пожалуйста, создавайте Issues или Pull Request'ы в репозитории.

## Лицензия

Этот проект распространяется под лицензией **GNU General Public License v3.0**.
Полный текст лицензии можно найти в файле `LICENSE` в корне репозитория или по адресу [https://www.gnu.org/licenses/gpl-3.0.html](https://www.gnu.org/licenses/gpl-3.0.html).