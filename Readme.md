# TeamTalk Telegram Sender (TTTM)

Репозиторий: [https://github.com/kirill-jjj/teamtalk-telegram-sender/](https://github.com/kirill-jjj/teamtalk-telegram-sender/)

[English version of README (README.en.md)](README.en.md) 

**Примечание:** Значительная часть кода этого бота (около 80%) была сгенерирована с помощью искусственного интеллекта. Хотя код был протестирован и находится в рабочем или близком к рабочему состоянию, некоторые его части могут быть не оптимальны или не полностью человекочитаемы. Вы можете встретить комментарии от ИИ, вроде `# изменено здесь` или аналогичные, оставленные в процессе разработки и отладки.

**Благодарности:**

*   Особая благодарность **[BlindMaster24](https://github.com/BlindMaster24)**, текущему активному разработчику и мейнтейнеру замечательной библиотеки [py-talk-ex](https://github.com/BlindMaster24/pytalk), за создание фундамента и первоначальной идеи бота, без которых дальнейшая разработка (в том числе с помощью ИИ) была бы затруднительна.
*   Спасибо **[gumerov-amir](https://github.com/gumerov-amir)**, разработчику TTMediaBot и других проектов, за помощь с исправлением команды `/help` после масштабного рефакторинга с использованием ИИ (в ныне удаленной ветке `ai-refactor`).
*   Благодарю **[a11cf0](https://github.com/a11cf0)** за множество исправлений на самом начальном этапе разработки, когда бот только учился пересылать сообщения администратору.

---

Этот бот служит мостом между сервером TeamTalk 5 и Telegram. Он отслеживает события входа и выхода пользователей на сервере TeamTalk и отправляет уведомления в Telegram. Также он может пересылать личные сообщения, адресованные боту в TeamTalk, администратору в Telegram.

## Основные возможности

*   **Уведомления о входе/выходе:** Отправка сообщений в Telegram, когда пользователь подключается или отключается от сервера TeamTalk.
*   **Пересылка личных сообщений:** Личные сообщения, отправленные боту в TeamTalk, могут быть пересланы указанному администратору в Telegram.
*   **Настраиваемые уведомления:** Пользователи Telegram могут настраивать параметры подписки на уведомления (все, только о входе, только о выходе, или никаких) через интерактивное меню `/settings`.
*   **Игнорирование пользователей и Режим "Mute All":** Возможность управлять списками игнорируемых/разрешенных пользователей и режимом "Mute All" через меню `/settings`.
*   **Функция "Не в сети" (Not on Online / NOON):** Если связанный с вашим Telegram-аккаунтом пользователь TeamTalk находится онлайн, уведомления в Telegram могут приходить без звука. Связь настраивается через команды `/sub` или `/not on online` в TeamTalk. Управление этой функцией также доступно в меню `/settings`.
*   **Команды в Telegram:**
    *   `/who`: Показать список пользователей онлайн на сервере TeamTalk.
    *   `/id`: Получить TeamTalk User ID пользователя (через кнопки).
    *   `/kick`, `/ban` (только для администраторов): Кикнуть или забанить пользователя с сервера TeamTalk (через кнопки).
    *   `/cl`: Сменить язык интерфейса бота (поддерживаются русский и английский).
    *   `/settings`: Открыть интерактивное меню для настройки языка, параметров подписки, функции "Не в сети" (NOON) и управления списками заблокированных/разрешенных пользователей.
    *   `/mute user <username>`, `/unmute user <username>`, `/mute_all`, `/unmute_all`: Быстрые команды для управления списками блокировок. Полное управление доступно в меню `/settings`.
    *   `/toggle_noon`, `/my_noon_status`: Быстрые команды для управления функцией "Не в сети" (NOON). Полное управление доступно в меню `/settings`.
*   **Команды в TeamTalk (в личные сообщения боту):**
    *   `/sub`: Получить ссылку для подписки на уведомления в Telegram.
    *   `/unsub`: Получить ссылку для отписки от уведомлений.
    *   `/add_admin`, `/remove_admin` (только для супер-администратора TeamTalk): Управление списком администраторов бота в Telegram.
    *   `/not on online`: Настройка функции "Не в сети".
*   **Многоязычность:** Поддержка русского и английского языков.

## Технологический стек

*   Python 3.11+
*   [aiogram](https://github.com/aiogram/aiogram) (асинхронный фреймворк для Telegram Bot API)
*   [py-talk-ex](https://github.com/BlindMaster24/pytalk) (библиотека для взаимодействия с TeamTalk 5 SDK)
*   SQLAlchemy (ORM для работы с базой данных)
*   Aiosqlite (асинхронный драйвер SQLite)
*   python-dotenv (управление переменными окружения)

## Установка и запуск

1.  **Установите `uv` (если еще не установлен):**
    *   **Для Linux и macOS:**
        ```bash
        curl -LsSf https://astral.sh/uv/install.sh | sh
source $HOME/.local/bin/env
        ```
    *   **Для Windows:** Самый простой способ, если у вас установлен Python и pip – это выполнить `pip install uv`. Другие способы установки (например, через установщик) можно найти на [официальном сайте Astral](https://astral.sh/uv#installation).

2.  **Клонируйте репозиторий:**
    ```bash
    git clone https://github.com/kirill-jjj/teamtalk-telegram-sender.git
    cd teamtalk-telegram-sender
    ```

3.  **Установите зависимости (команда `uv sync` автоматически создаст виртуальное окружение в папке `.venv`, если оно не существует, и установит в него все необходимые пакеты):**
    ```bash
    uv sync
    ```
    *(Эта команда подготовит окружение со всеми зависимостями.)*

4.  **Настройте переменные окружения:**
    Скопируйте файл `.env.example` в новый файл с именем `.env`:
    ```bash
    cp .env.example .env
    ```
    Затем откройте файл `.env` в текстовом редакторе и заполните его вашими актуальными данными (токенами, адресами серверов, учетными данными и т.д.), следуя комментариям в файле. **Никогда не добавляйте ваш `.env` файл в систему контроля версий (Git).**

5.  **Запустите бота (используя `uv run` для автоматического использования правильного окружения и его синхронизации):**
    ```bash
    uv run python sender.py
    ```
    Если вы хотите указать путь к `.env` файлу, отличающийся от текущей директории:
    ```bash
    uv run python sender.py /путь/к/вашему/.env
    ```

## Использование

### Команды в Telegram

После запуска бота и его первоначальной настройки (рекомендуется подписаться на уведомления через команду `/sub` в личных сообщениях боту в TeamTalk), вы можете использовать следующие команды в чате с ботом в Telegram:

*   `/start`: Начало работы с ботом, обработка deeplink-ссылок.
*   `/who`: Показать список пользователей онлайн на сервере TeamTalk.
*   `/id`: Получить TeamTalk User ID указанного пользователя (выбор через кнопки).
*   `/help`: Показать справочное сообщение.
*   `/cl en` или `/cl ru`: Сменить язык бота.
*   `/settings`: Открыть интерактивное меню для настройки языка, параметров подписки, функции "Не в сети" (NOON) и управления списками заблокированных/разрешенных пользователей.
*   `/mute user <TeamTalk_username>`: Быстрая команда для добавления пользователя TeamTalk в список блокировки. Полное управление списками блокировок доступно в меню `/settings`.
*   `/unmute user <TeamTalk_username>`: Быстрая команда для удаления пользователя из списка блокировки. Полное управление списками блокировок доступно в меню `/settings`.
*   `/mute_all`: Включить режим "Блокировать всех". Уведомления будут приходить только от пользователей из списка исключений. Полное управление списками блокировок доступно в меню `/settings`.
*   `/unmute_all`: Отключить режим "Блокировать всех". Список исключений будет очищен. Полное управление списками блокировок доступно в меню `/settings`.
*   `/toggle_noon`: Быстрое включение/выключение функции "Не в сети". Эта функция также доступна для настройки в меню `/settings`.
*   `/my_noon_status`: Проверить статус функции "Не в сети".
*   `/kick` (только для администраторов Telegram): Кикнуть пользователя TeamTalk (выбор через кнопки).
*   `/ban` (только для администраторов Telegram): Забанить пользователя TeamTalk (выбор через кнопки).

### Команды в TeamTalk (в личные сообщения боту)

*   `/sub`: Получить ссылку для подписки на уведомления в Telegram. Этот процесс также свяжет вашу учетную запись TeamTalk для функции "Не в сети" (NOON), которая изначально будет выключена. Если вы уже подписаны и функция NOON связана с этой же учетной записью TeamTalk, ваш текущий статус NOON (включено/выключено) будет сохранен.
*   `/unsub`: Получить ссылку для отписки от уведомлений. Это удалит вашу подписку, а также все связанные с ней данные и настройки функций (включая конфигурацию "Не в сети") из бота.
*   `/add_admin <Telegram_ID_1> <Telegram_ID_2> ...`: (Только для `ADMIN_USERNAME` из `.env`) Добавить администраторов бота в Telegram.
*   `/remove_admin <Telegram_ID_1> <Telegram_ID_2> ...`: (Только для `ADMIN_USERNAME` из `.env`) Удалить администраторов бота в Telegram.
*   `/not on online`: Настроить или переподтвердить функцию "Не в сети" (NOON). Этот метод включает NOON по умолчанию после успешной привязки через Telegram.
*   `/help`: Показать справку по командам TeamTalk.

Любое другое текстовое сообщение, отправленное боту в TeamTalk в ЛС, будет переслано `TG_ADMIN_CHAT_ID`, если он указан.

## Замечания по настройке "Не в сети" (NOON)

Функция "Не в сети" (NOON) позволяет доставлять уведомления от бота в Telegram без звука, если связанный с вами пользователь TeamTalk в данный момент находится онлайн. Это помогает уменьшить количество звуковых оповещений, если вы активно используете TeamTalk.

Вы можете настроить связь между вашим Telegram-аккаунтом и именем пользователя TeamTalk двумя способами:

**Способ 1: Используя команду `/sub` (Рекомендуется для новых пользователей)**
1.  Отправьте команду `/sub` боту в личные сообщения в TeamTalk.
2.  Бот пришлет вам в TeamTalk deeplink-ссылку для Telegram.
3.  Откройте эту ссылку. Она должна вести на вашего Telegram-бота.
4.  Нажмите "Старт" в Telegram. Бот подтвердит вашу подписку и сообщит, что функция NOON связана с вашей учетной записью TeamTalk.
5.  По умолчанию для этого способа функция NOON будет **выключена**. Вы можете включить ее с помощью команды `/toggle_noon` в Telegram или через меню `/settings`.
6.  Если вы уже были подписаны и функция NOON уже была связана с этой же учетной записью TeamTalk, повторное нажатие на ссылку из `/sub` не изменит ваш текущий статус NOON (включено/выключено).

**Способ 2: Используя команду `/not on online`**
1.  Отправьте команду `/not on online` боту в личные сообщения в TeamTalk.
2.  Бот пришлет вам в TeamTalk deeplink-ссылку для Telegram.
3.  Откройте эту ссылку. Она должна вести на вашего Telegram-бота.
4.  Нажмите "Старт" в Telegram. Бот подтвердит настройку.
5.  По умолчанию для этого способа функция NOON будет **включена**.

После настройки и включения, если связанная учетная запись TeamTalk находится онлайн на сервере, уведомления от бота в Telegram будут приходить без звука. Вы можете использовать команду `/toggle_noon` в Telegram или опцию в меню `/settings` для включения или выключения тихих уведомлений, а `/my_noon_status` — для проверки текущего состояния.

## Вклад (Contributing)

Предложения по улучшению и сообщения об ошибках приветствуются! Пожалуйста, создавайте Issues или Pull Request'ы в репозитории.

## Лицензия

Этот проект распространяется под лицензией **GNU General Public License v3.0**.
Полный текст лицензии можно найти в файле `LICENSE` в корне репозитория или по адресу [https://www.gnu.org/licenses/gpl-3.0.html](https://www.gnu.org/licenses/gpl-3.0.html).