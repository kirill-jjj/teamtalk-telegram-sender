# TeamTalk Telegram Sender (TTTM)

Репозиторий: [https://github.com/kirill-jjj/teamtalk-telegram-sender/](https://github.com/kirill-jjj/teamtalk-telegram-sender/)

[English version of README (README.en.md)](README.en.md) 

**Примечание:** Значительная часть кода этого бота (около 80%) была сгенерирована с помощью искусственного интеллекта. Хотя код был протестирован и находится в рабочем или близком к рабочему состоянию, некоторые его части могут быть не оптимальны или не полностью человекочитаемы. Вы можете встретить комментарии от ИИ, вроде `# изменено здесь` или аналогичные, оставленные в процессе разработки и отладки.

**Благодарности:**

*   Особая благодарность **[BlindMaster24](https://github.com/BlindMaster24)**, текущему активному разработчику и мейнтейнеру замечательной библиотеки [py-talk-ex](https://github.com/BlindMaster24/pytalk), за создание фундамента и первоначальной идеи бота, без которых дальнейшая разработка (в том числе с помощью ИИ) была бы затруднительна.
*   Спасибо **[gumerov-amir](https://github.com/gumerov-amir)**, разработчику TTMediaBot и других проектов, за помощь с исправлением команды `/help` после масштабного рефакторинга с использованием ИИ (в ныне удаленной ветке `ai-refactor`).
*   Благодарю **[a11cf0](https://github.com/a11cf0)** за множество исправлений на самом начальном этапе разработки, когда бот только учился пересылать сообщения администратору.

---

Этот бот служит мостом между сервером TeamTalk 5 и Telegram. Он отслеживает события входа и выхода пользователей на сервере TeamTalk и отправляет уведомления в Telegram. Также он может пересылать личные сообщения, адресованные боту в TeamTalk, администратору в Telegram.

## Основные возможности

*   **Уведомления о входе/выходе:** Отправка сообщений в Telegram, когда пользователь подключается или отключается от сервера TeamTalk.
*   **Пересылка личных сообщений:** Личные сообщения, отправленные боту в TeamTalk, могут быть пересланы указанному администратору в Telegram.
*   **Интерактивные настройки через Telegram:**
    *   `/settings`: Предоставляет доступ к комплексному меню для управления языком интерфейса, параметрами подписки на уведомления (все, только о входе, только о выходе, или никаких), списками блокировки/разрешения пользователей (Mute-листы), а также функцией "Не в сети" (NOON).
*   **Просмотр активных пользователей:**
    *   `/who`: Показывает список пользователей, находящихся онлайн на сервере TeamTalk.
*   **Администрирование пользователей TeamTalk (для администраторов Telegram):**
    *   `/kick`: Инициирует процесс исключения пользователя с сервера TeamTalk (выбор пользователя осуществляется через интерактивные кнопки).
    *   `/ban`: Инициирует процесс блокировки (бана) пользователя на сервере TeamTalk (выбор пользователя осуществляется через интерактивные кнопки).
*   **Функция "Не в сети" (Not on Online / NOON):**
    *   Активируется через команду `/sub` в личных сообщениях боту на сервере TeamTalk, что связывает ваш TeamTalk аккаунт с Telegram.
    *   Если функция NOON включена в настройках Telegram (`/settings`) и связанный пользователь TeamTalk находится онлайн, уведомления от бота в Telegram будут приходить без звука.
*   **Команды управления через TeamTalk (в личные сообщения боту):**
    *   `/sub`: Отправляет пользователю deeplink-ссылку для подписки на уведомления в Telegram и для связывания аккаунта TeamTalk для использования функции NOON.
    *   `/unsub`: Отправляет пользователю deeplink-ссылку для отписки от уведомлений в Telegram.
    *   `/add_admin <ID Telegram>`: Позволяет главному администратору (указанному в конфигурации) добавлять других администраторов бота в Telegram.
    *   `/remove_admin <ID Telegram>`: Позволяет главному администратору удалять администраторов бота в Telegram.
    *   `/help`: Отображает справку по доступным командам в TeamTalk.
*   **Многоязычность:** Поддержка русского и английского языков интерфейса в Telegram.
*   **Получение справки:**
    *   `/help`: Отображает справочное сообщение со списком доступных команд и их описанием в Telegram.

## Технологический стек

*   Python 3.11+
*   [aiogram](https://github.com/aiogram/aiogram) (асинхронный фреймворк для Telegram Bot API)
*   [py-talk-ex](https://github.com/BlindMaster24/pytalk) (библиотека для взаимодействия с TeamTalk 5 SDK)
*   SQLAlchemy (ORM для работы с базой данных)
*   Aiosqlite (асинхронный драйвер SQLite)
*   python-dotenv (управление переменными окружения)

## Установка и запуск

1.  **Установите `uv`**: Этот проект использует `uv` для управления пакетами и виртуальными окружениями. Следуйте официальному руководству по установке `uv`: [https://github.com/astral-sh/uv#installation](https://github.com/astral-sh/uv#installation)
2.  **Клонируйте репозиторий**:
    ```bash
    git clone <URL-репозитория>
    cd <имя-репозитория>
    ```
3.  **Установите зависимости**: Создайте виртуальное окружение и установите зависимости с помощью `uv`.
    ```bash
    uv venv
    uv sync
    ```
    (`uv sync` создаст виртуальное окружение `.venv`, если оно не существует, и установит все зависимости. `uv` автоматически использует это окружение для команд типа `uv run`.)
4.  **Сгенерируйте файлы локализации**: Проект использует систему локализации на основе gettext, управляемую скриптом `manage-locales.py` с использованием Babel. Эти команды должны выполняться из корневого каталога проекта.
    *   Для извлечения всех переводимых строк из кода в файл шаблона (`bot/locales/messages.pot`):
        ```bash
        uv run manage-locales.py extract
        ```
    *   Для создания или обновления `.po` файлов для конкретных языков (например, для русского `ru`, расположенного в `bot/locales/ru/LC_MESSAGES/messages.po`):
        ```bash
        uv run manage-locales.py update
        ```
        (Скрипт `manage-locales.py` динамически обнаружит языки на основе подкаталогов в `bot/locales/`. Если вы добавляете новый язык, например, 'de', сначала создайте `bot/locales/de/LC_MESSAGES/`, а затем выполните эту команду.)
    *   Для компиляции `.po` файлов в бинарные `.mo` файлы, используемые ботом во время выполнения:
        ```bash
        uv run manage-locales.py
        ```
    (Обычно, после первоначальной настройки, разработчики запускают `uv run manage-locales.py extract` при добавлении нового текста, затем `uv run manage-locales.py update`, затем переводят строки и, наконец, `uv run manage-locales.py` для компиляции.)
5.  **Настройте переменные окружения**: Скопируйте файл `.env.example` в новый файл с именем `.env` и заполните его вашими реальными конфигурационными значениями (API токены, ID администраторов и т.д.).
    ```bash
    cp .env.example .env
    # Теперь отредактируйте .env, указав ваши значения
    ```
6.  **Примените миграции базы данных**:
    Перед первым запуском или после обновления моделей базы данных, примените миграции:
    ```bash
    uv run alembic upgrade head
    ```
7.  **Запустите бота**:
    ```bash
    uv run sender.py
    ```
    Вы также можете указать конкретный файл конфигурации (вместо `.env` по умолчанию) с помощью опции `--config`:
    ```bash
    uv run sender.py -- --config custom.env
    ```
    (Обратите внимание на `--` перед `--config custom.env`. Это сообщает `uv run`, что последующие аргументы предназначены для скрипта `sender.py`, а не для самой команды `uv`.)

## Миграции базы данных

Этот проект использует Alembic для управления изменениями схемы базы данных.

### Когда использовать миграции

*   **При первоначальной настройке**: Перед первым запуском бота необходимо применить начальную миграцию для создания таблиц в базе данных.
*   **После обновления моделей**: Если вы изменили модели SQLAlchemy в `bot/models.py` (например, добавили новую таблицу или столбец), вам нужно будет создать и применить новую миграцию.

### Основные команды Alembic

Для управления миграциями рекомендуется использовать скрипт `manage-migrations.py`, который позволяет легко указать файл конфигурации для подключения к базе данных. Команды выполняются с помощью `uv run`.

*   **Применение миграций (рекомендуемый способ)**:
    Чтобы применить все ожидающие миграции к базе данных (используя конфигурацию из `.env` по умолчанию):
    ```bash
    uv run manage-migrations.py -- upgrade head
    ```
    Если вы используете другой файл конфигурации (например, `prod.env`):
    ```bash
    uv run manage-migrations.py -- --config prod.env upgrade head
    ```
    (Обратите внимание на `--` перед `--config prod.env`. Это сообщает `uv run`, что последующие аргументы предназначены для скрипта `manage-migrations.py`.)

*   **Создание новой ревизии (миграции) (рекомендуемый способ)**:
    После изменения моделей в `bot/models.py`, используйте `manage-migrations.py` для создания ревизии:
    ```bash
    uv run manage-migrations.py -- revision -m "краткое_описание_изменений" --autogenerate
    ```
    Или с кастомным конфигом:
    ```bash
    uv run manage-migrations.py -- --config prod.env revision -m "краткое_описание_изменений" --autogenerate
    ```
    Эта команда создаст новый файл миграции в `alembic/versions/`. Важно **проверить** этот файл и при необходимости внести ручные корректировки, так как автогенерация не всегда идеальна.

Вы также можете выполнять команды Alembic напрямую, если это необходимо, хотя для большинства случаев `manage-migrations.py` предпочтительнее. `uv` автоматически использует активированное виртуальное окружение.

*   **Создание новой ревизии (миграции) (прямой вызов Alembic)**:
    ```bash
    uv run alembic revision -m "краткое_описание_изменений" --autogenerate
    ```

*   **Применение миграций (прямой вызов Alembic)**:
    ```bash
    uv run alembic upgrade head
    ```
    При прямом вызове `alembic`, он будет использовать конфигурацию базы данных, как определено в `alembic/env.py`, который по умолчанию читает `.env` (через `bot.config`).

*   **Откат миграций**:
    Чтобы отменить последнюю примененную миграцию:
    ```bash
    uv run alembic downgrade -1
    ```
    Чтобы откатиться до определенной ревизии (замените `<revision_id>` на хеш нужной ревизии):
    ```bash
    uv run alembic downgrade <revision_id>
    ```
    Чтобы откатить все миграции (возврат к пустой базе данных, только схема):
    ```bash
    uv run alembic downgrade base
    ```

*   **Просмотр текущей ревизии**:
    Показывает текущую ревизию базы данных.
    ```bash
    uv run alembic current
    ```

*   **Просмотр истории миграций**:
    Показывает список всех миграций и их статус.
    ```bash
    uv run alembic history
    ```

## Использование

### Команды в Telegram

После запуска бота и его первоначальной настройки (рекомендуется инициировать подписку через команду `/sub` в личных сообщениях боту в TeamTalk), вы можете использовать следующие команды в чате с ботом в Telegram:

*   `/start`: Начало работы с ботом. Также используется для обработки deeplink-ссылок (например, для подтверждения подписки или отписки).
*   `/who`: Показать список пользователей, находящихся онлайн на сервере TeamTalk.
*   `/settings`: Открыть интерактивное меню для настройки языка, параметров подписки на уведомления, управления списками блокировки/разрешения пользователей и функции "Не в сети" (NOON).
*   `/help`: Показать справочное сообщение со списком доступных команд и их описанием.

**Команды для администраторов Telegram:**

*   `/kick`: Инициировать исключение пользователя с сервера TeamTalk (выбор пользователя через кнопки).
*   `/ban`: Инициировать блокировку пользователя на сервере TeamTalk (выбор пользователя через кнопки).

### Команды в TeamTalk (в личные сообщения боту)

*   `/sub`: Получить ссылку для подписки на уведомления в Telegram. Этот процесс также связывает вашу учетную запись TeamTalk для функции "Не в сети" (NOON).
*   `/unsub`: Получить ссылку для отписки от уведомлений. Это удалит вашу подписку и все связанные с ней данные и настройки.
*   `/add_admin <ID Telegram_1> <ID Telegram_2> ...`: (Только для главного администратора, указанного в конфигурации) Добавить администраторов бота в Telegram.
*   `/remove_admin <ID Telegram_1> <ID Telegram_2> ...`: (Только для главного администратора, указанного в конфигурации) Удалить администраторов бота в Telegram.
*   `/help`: Показать справку по доступным командам TeamTalk.

Любое другое текстовое сообщение, отправленное боту в TeamTalk в ЛС, будет переслано администратору в Telegram (если `TG_ADMIN_CHAT_ID` указан в конфигурации).

## Замечания по настройке "Не в сети" (NOON)

Функция "Не в сети" (NOON) позволяет доставлять уведомления от бота в Telegram без звука, если связанный с вашим Telegram-аккаунтом пользователь TeamTalk в данный момент находится онлайн. Это помогает уменьшить количество звуковых оповещений, если вы активно используете TeamTalk.

**Активация и управление функцией NOON:**
1.  **Связывание аккаунта:** Отправьте команду `/sub` боту в личные сообщения на сервере TeamTalk. Бот пришлет вам deeplink-ссылку.
2.  **Подтверждение в Telegram:** Откройте эту ссылку в Telegram и нажмите "Старт". Это действие подпишет вас на уведомления и свяжет ваш аккаунт TeamTalk для функции NOON.
3.  **Управление NOON:** После связывания, управление функцией NOON (включение/выключение) осуществляется через меню `/settings` в Telegram.

Если функция NOON включена и связанная учетная запись TeamTalk находится онлайн на сервере, уведомления от бота в Telegram будут приходить без звука.

## Вклад (Contributing)

Предложения по улучшению и сообщения об ошибках приветствуются! Пожалуйста, создавайте Issues или Pull Request'ы в репозитории.

### Работа с переводами

Этот проект использует рабочий процесс на основе gettext для обработки переводов, управляемый с помощью скрипта `manage-locales.py` и Babel. Файлы локализации находятся в каталоге `bot/locales`.

1.  **Извлечение переводимых строк**:
    Когда вы добавляете или изменяете любые строки в коде Python, предназначенные для пользователя и требующие перевода (т.е. строки, обернутые в `_()`), вам необходимо обновить файл шаблона сообщений (`messages.pot`).
    ```bash
    uv run manage-locales.py extract
    ```
    Эта команда сканирует кодовую базу (согласно конфигурации в `babel.cfg`) и обновляет `bot/locales/messages.pot`.

2.  **Обновление каталогов языков (.po файлы)**:
    После обновления шаблона `.pot` обновите `.po` файлы для каждого поддерживаемого языка. Скрипт `manage-locales.py` динамически определяет языки, ища подкаталоги в `bot/locales/`.
    ```bash
    uv run manage-locales.py update
    ```
    Эта команда объединяет новые строки из `messages.pot` в каждый файл `<код_языка>/LC_MESSAGES/messages.po`. Новые строки будут добавлены, а измененные строки будут помечены как "fuzzy" (неточные) для проверки. Если вы создали новый каталог для языка (например, `bot/locales/de/LC_MESSAGES/`), эта команда также инициализирует его файл `messages.po` на основе шаблона.

3.  **Перевод**:
    Отредактируйте `.po` файлы (например, `bot/locales/ru/LC_MESSAGES/messages.po`), используя предпочитаемый PO-редактор (например, Poedit, OmegaT) или текстовый редактор. Для каждого `msgid` (исходная строка) укажите перевод в поле `msgstr`. Для записей, помеченных `#, fuzzy`, проверьте перевод на соответствие новому `msgid`, исправьте его при необходимости, а затем удалите комментарий `#, fuzzy`.

4.  **Компиляция переводов (.mo файлы)**:
    После перевода скомпилируйте `.po` файлы в бинарные `.mo` файлы, которые используются приложением во время выполнения.
    ```bash
    uv run manage-locales.py
    ```
    Эта команда разместит `.mo` файлы в соответствующем каталоге `LC_MESSAGES` для каждого языка (например, `bot/locales/ru/LC_MESSAGES/messages.mo`). Затем бот сможет использовать эти скомпилированные переводы в зависимости от языковых предпочтений пользователя.

**Добавление нового языка (например, немецкого 'de'):**
1.  Создайте структуру каталогов: `mkdir -p bot/locales/de/LC_MESSAGES/`
2.  Выполните `uv run manage-locales.py update`. Скрипт `manage-locales.py` должен найти 'de' и инициализировать `bot/locales/de/LC_MESSAGES/messages.po`.
3.  Переведите новый `.po` файл.
4.  Выполните `uv run manage-locales.py` для его компиляции.
5.  Убедитесь, что код языка 'de' доступен для выбора пользователями в настройках бота.

## Лицензия

Этот проект распространяется под лицензией **GNU General Public License v3.0**.
Полный текст лицензии можно найти в файле `LICENSE` в корне репозитория или по адресу [https://www.gnu.org/licenses/gpl-3.0.html](https://www.gnu.org/licenses/gpl-3.0.html).