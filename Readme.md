# TeamTalk Telegram Sender (TTTM)

Репозиторий: [https://github.com/kirill-jjj/teamtalk-telegram-sender/](https://github.com/kirill-jjj/teamtalk-telegram-sender/)

**Примечание:** Значительная часть кода этого бота (около 80%) была сгенерирована с помощью искусственного интеллекта. Хотя код был протестирован и находится в рабочем или близком к рабочему состоянию, некоторые его части могут быть не оптимальны или не полностью человекочитаемы. Вы можете встретить комментарии от ИИ, вроде `# изменено здесь` или аналогичные, оставленные в процессе разработки и отладки.

**Благодарности:**

*   Особая благодарность **[BlindMaster24](https://github.com/BlindMaster24)**, текущему активному разработчику и мейнтейнеру замечательной библиотеки [py-talk-ex](https://github.com/BlindMaster24/pytalk), за создание фундамента и первоначальной идеи бота, без которых дальнейшая разработка (в том числе с помощью ИИ) была бы затруднительна.
*   Спасибо **[gumerov-amir](https://github.com/gumerov-amir)**, разработчику TTMediaBot и других проектов, за помощь с исправлением команды `/help` после масштабного рефакторинга с использованием ИИ (в ныне удаленной ветке `ai-refactor`).
*   Благодарю **[a11cf0](https://github.com/a11cf0)** за множество исправлений на самом начальном этапе разработки, когда бот только учился пересылать сообщения администратору.

---

Этот бот служит мостом между сервером TeamTalk 5 и Telegram. Он отслеживает события входа и выхода пользователей на сервере TeamTalk и отправляет уведомления в Telegram. Также он может пересылать личные сообщения, адресованные боту в TeamTalk, администратору в Telegram.

## Основные возможности

*   **Уведомления о входе/выходе:** Отправка сообщений в Telegram, когда пользователь подключается или отключается от сервера TeamTalk.
*   **Пересылка личных сообщений:** Личные сообщения, отправленные боту в TeamTalk, могут быть пересланы указанному администратору в Telegram.
*   **Настраиваемые уведомления:** Пользователи Telegram могут настраивать, какие уведомления они хотят получать (все, только о входе, только о выходе, или никаких).
*   **Игнорирование пользователей:** Возможность добавить определенных пользователей TeamTalk в список игнорирования, чтобы не получать от них уведомления.
*   **Режим "Mute All":** Позволяет получать уведомления только от избранных пользователей TeamTalk (список исключений).
*   **Функция "Не в сети" (Not on Online / NOON):** Если связанный с Telegram-аккаунтом пользователь TeamTalk находится онлайн, уведомления в Telegram будут приходить без звука. Настраивается через TeamTalk.
*   **Команды в Telegram:**
    *   `/who`: Показать список пользователей онлайн на сервере TeamTalk.
    *   `/id`: Получить TeamTalk User ID пользователя (через кнопки).
    *   `/kick`, `/ban` (только для администраторов): Кикнуть или забанить пользователя с сервера TeamTalk (через кнопки).
    *   `/cl`: Сменить язык интерфейса бота (поддерживаются русский и английский).
    *   Команды для управления настройками уведомлений и списками игнорирования.
*   **Команды в TeamTalk (в личные сообщения боту):**
    *   `/sub`: Получить ссылку для подписки на уведомления в Telegram.
    *   `/unsub`: Получить ссылку для отписки от уведомлений.
    *   `/add_admin`, `/remove_admin` (только для супер-администратора TeamTalk): Управление списком администраторов бота в Telegram.
    *   `/not on online`: Настройка функции "Не в сети".
*   **Многоязычность:** Поддержка русского и английского языков.

## Технологический стек

*   Python 3.11+
*   [aiogram](https://github.com/aiogram/aiogram) (асинхронный фреймворк для Telegram Bot API)
*   [py-talk-ex](https://github.com/BlindMaster24/pytalk) (библиотека для взаимодействия с TeamTalk 5 SDK)
*   SQLAlchemy (ORM для работы с базой данных)
*   Aiosqlite (асинхронный драйвер SQLite)
*   python-dotenv (управление переменными окружения)

## Установка и запуск

1.  **Клонируйте репозиторий:**
    ```bash
    git clone https://github.com/kirill-jjj/teamtalk-telegram-sender.git
    cd teamtalk-telegram-sender
    ```

2.  **Установите зависимости:**
    ```bash
    pip install -r requirements.txt
    ```

3.  **Настройте переменные окружения:**
    Скопируйте файл `.env.example` (если он есть в вашем репозитории, если нет - создайте `.env`) и заполните его вашими данными:
    ```dotenv
    # Telegram Bot Tokens
    TG_BOT_TOKEN="ВАШ_ОСНОВНОЙ_ТОКЕН_БОТА_TELEGRAM" # Обязательно
    TG_EVENT_TOKEN=""               # Опционально: Токен для уведомлений (если пуст, используется TG_BOT_TOKEN)
    TG_BOT_MESSAGE_TOKEN=""         # Опционально: Токен для пересылки ЛС из TT (если пуст, эта функция неактивна)
    TG_ADMIN_CHAT_ID=""             # Опционально: ID вашего чата в Telegram для получения ЛС из TT и админ-уведомлений

    # TeamTalk Server Connection
    HOST_NAME="АДРЕС_ВАШЕГО_TEAMTALK_СЕРВЕРА" # Обязательно
    PORT="10333"                    # Опционально: TCP/UDP порт TeamTalk (по умолчанию 9987, если не указан)
    ENCRYPTED="0"                   # Опционально: 1 для шифрования, 0 для отсутствия (по умолчанию 0)

    # TeamTalk Bot Account
    USER_NAME="ИМЯ_ПОЛЬЗОВАТЕЛЯ_БОТА_В_TT"   # Обязательно
    PASSWORD="ПАРОЛЬ_БОТА_В_TT"           # Обязательно
    CHANNEL="ПУТЬ/К/КАНАЛУ или ID_КАНАЛА" # Обязательно: Канал, куда бот будет заходить
    CHANNEL_PASSWORD=""             # Опционально: Пароль для входа на канал
    NICK_NAME="НИКНЕЙМ_БОТА_В_TT"         # Обязательно
    STATUS_TEXT="Статусное сообщение бота" # Опционально: Статус бота в TeamTalk
    CLIENT_NAME="TTTM Bot"          # Опционально: Имя клиента, отображаемое в TT (по умолчанию TTTM)
    SERVER_NAME="Мой Сервер"        # Опционально: Отображаемое имя сервера в уведомлениях

    # Bot Administration
    ADMIN_USERNAME=""               # Опционально: Имя пользователя TeamTalk (супер-админ), который может использовать /add_admin и /remove_admin в ЛС бота TT
    GLOBAL_IGNORE_USERNAME=""       # Опционально: Имя пользователя TeamTalk, уведомления о котором будут глобально игнорироваться

    # Database
    DATABASE_FILE="bot_data.db"     # Опционально: Имя файла базы данных SQLite (по умолчанию bot_data.db)
    ```
    *(Примечание: Если у вас нет файла `.env.example`, рекомендуется его создать с перечисленными выше переменными, чтобы пользователи знали, что настраивать.)*

4.  **Запустите бота:**
    ```bash
    python sender.py
    ```
    Если вы хотите указать путь к `.env` файлу, отличающийся от текущей директории:
    ```bash
    python sender.py /путь/к/вашему/.env
    ```

## Использование

### Команды в Telegram

После запуска бота и его первоначальной настройки (рекомендуется подписаться на уведомления через команду `/sub` в личных сообщениях боту в TeamTalk), вы можете использовать следующие команды в чате с ботом в Telegram:

*   `/start`: Начало работы с ботом, обработка deeplink-ссылок.
*   `/who`: Показать список пользователей онлайн на сервере TeamTalk.
*   `/id`: Получить TeamTalk User ID указанного пользователя (выбор через кнопки).
*   `/help`: Показать справочное сообщение.
*   `/cl en` или `/cl ru`: Сменить язык бота.
*   `/notify_all`: Включить все уведомления о входе/выходе.
*   `/notify_join_off`: Отключить уведомления о входе.
*   `/notify_leave_off`: Отключить уведомления о выходе.
*   `/notify_none`: Отключить все уведомления.
*   `/mute user <TeamTalk_username>`: Добавить пользователя TeamTalk в список игнорирования (не получать от него уведомления).
*   `/unmute user <TeamTalk_username>`: Удалить пользователя из списка игнорирования.
*   `/mute_all`: Включить режим "Mute All". Уведомления будут приходить только от пользователей из списка игнорирования (который в этом режиме работает как список исключений).
*   `/unmute_all`: Отключить режим "Mute All". Уведомления будут приходить от всех, кроме тех, кто в списке игнорирования.
*   `/toggle_noon`: Включить/выключить функцию "Не в сети".
*   `/my_noon_status`: Проверить статус функции "Не в сети".
*   `/kick` (только для администраторов Telegram): Кикнуть пользователя TeamTalk (выбор через кнопки).
*   `/ban` (только для администраторов Telegram): Забанить пользователя TeamTalk (выбор через кнопки).

### Команды в TeamTalk (в личные сообщения боту)

*   `/sub`: Получить ссылку для подписки на уведомления в Telegram.
*   `/unsub`: Получить ссылку для отписки от уведомлений.
*   `/add_admin <Telegram_ID_1> <Telegram_ID_2> ...`: (Только для `ADMIN_USERNAME` из `.env`) Добавить администраторов бота в Telegram.
*   `/remove_admin <Telegram_ID_1> <Telegram_ID_2> ...`: (Только для `ADMIN_USERNAME` из `.env`) Удалить администраторов бота в Telegram.
*   `/not on online`: Настроить функцию "Не в сети" (для тихих уведомлений в Telegram, когда вы онлайн в TeamTalk).
*   `/help`: Показать справку по командам TeamTalk.

Любое другое текстовое сообщение, отправленное боту в TeamTalk в ЛС, будет переслано `TG_ADMIN_CHAT_ID`, если он указан.

## Замечания по настройке "Не в сети" (NOON)

1.  Отправьте команду `/not on online` боту в личные сообщения в TeamTalk.
2.  Бот пришлет вам в TeamTalk ссылку.
3.  Откройте эту ссылку. Она должна вести на вашего Telegram-бота с параметром `start`.
4.  Нажмите "Старт" в Telegram. Бот подтвердит настройку.
5.  Теперь вы можете использовать команду `/toggle_noon` в Telegram для включения/выключения этой функции. Если функция включена и ваш TeamTalk-аккаунт, связанный при настройке NOON, находится онлайн на сервере, уведомления от бота в Telegram будут приходить без звука.

## Вклад (Contributing)

Предложения по улучшению и сообщения об ошибках приветствуются! Пожалуйста, создавайте Issues или Pull Request'ы в репозитории.

## Лицензия

Этот проект распространяется под лицензией **GNU General Public License v3.0**.
Полный текст лицензии можно найти в файле `LICENSE` в корне репозитория или по адресу [https://www.gnu.org/licenses/gpl-3.0.html](https://www.gnu.org/licenses/gpl-3.0.html).